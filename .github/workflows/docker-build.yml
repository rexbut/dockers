name: Build Docker Images

on:
  push:
    branches:
      - '**'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  # Utilise le nom complet du repo (owner/repo)
  IMAGE_PREFIX: ${{ github.repository }}
  HOMEASSISTANT_VERSION: "2025.12"

jobs:
  build-ubuntu:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        run: |
          echo "branch=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT
          echo "short_sha=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT
          echo "run_id=${{ github.run_id }}" >> $GITHUB_OUTPUT
          echo "build_date=$(date -u +'%Y%m%d')" >> $GITHUB_OUTPUT

      - name: Build and push Ubuntu
        uses: docker/build-push-action@v5
        with:
          context: ./ubuntu
          file: ./ubuntu/Dockerfile
          platforms: linux/arm64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/ubuntu:build-${{ steps.meta.outputs.run_id }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/ubuntu:latest

  build-kubectl-helm:
    runs-on: ubuntu-latest
    needs: build-ubuntu
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        run: |
          echo "branch=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT
          echo "short_sha=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT
          echo "kube_version=1.27.1" >> $GITHUB_OUTPUT
          echo "helm_version=3.11.3" >> $GITHUB_OUTPUT

      - name: Build and push kubectl-helm
        uses: docker/build-push-action@v5
        with:
          context: ./kubectl-helm
          file: ./kubectl-helm/Dockerfile
          platforms: linux/arm64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/kubectl-helm:${{ steps.meta.outputs.branch }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/kubectl-helm:k8s-${{ steps.meta.outputs.kube_version }}-helm-${{ steps.meta.outputs.helm_version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/kubectl-helm:latest
          build-args: |
            GITHUB_REGISTRY=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}
            GITHUB_BRANCH=${{ steps.meta.outputs.branch }}
            ARCH=arm64
            KUBE_VERSION=${{ steps.meta.outputs.kube_version }}
            HELM_VERSION=${{ steps.meta.outputs.helm_version }}
            YQ_VERSION=4.33.3

  build-network-ups-tools:
    runs-on: ubuntu-latest
    needs: build-ubuntu
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        run: |
          echo "branch=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT
          echo "short_sha=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT

      - name: Build and push network-ups-tools
        uses: docker/build-push-action@v5
        with:
          context: ./network-ups-tools
          file: ./network-ups-tools/Dockerfile
          platforms: linux/arm64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/network-ups-tools:${{ steps.meta.outputs.branch }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/network-ups-tools:latest
          build-args: |
            GITHUB_REGISTRY=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}
            GITHUB_BRANCH=${{ steps.meta.outputs.branch }}

  build-homeassistant:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        run: |
          echo "branch=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT
          echo "short_sha=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT

      - name: Build and push homeassistant
        uses: docker/build-push-action@v5
        with:
          context: ./homeassistant
          file: ./homeassistant/Dockerfile
          platforms: linux/arm64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/homeassistant:${{ env.HOMEASSISTANT_VERSION }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/homeassistant:latest
          build-args: |
            HOMEASSISTANT_VERSION=${{ env.HOMEASSISTANT_VERSION }}

